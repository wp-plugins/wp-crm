<?php/**   * WP-Invoice Connector   *   */   //** Load user invoices into global user */   add_action('wp_crm_user_loaded', array('WPI_WPC', 'wp_crm_user_loaded'));   class WPI_WPC {    function wp_crm_user_loaded($wp_crm_user) {      global $wp_crm_user;      $user_email = $wp_crm_user['user_email']['default'][0];      $wpi_query['recipient'] = 19;      $wpi_query['m'] = 0;      if($user_invoices = WPI_Functions::query($wpi_query)) {        $wp_crm_user['has_invoices'] = true;        $wp_crm_user['user_invoices'] = $user_invoices;      }      add_action('wp_crm_metaboxes', array('WPI_WPC', 'wp_crm_metaboxes'));    }    function wp_crm_metaboxes() {      global $wp_crm_user;      if($wp_crm_user['has_invoices']) {        add_meta_box("Invoices", "Invoices" , array('WPI_WPC', 'metabox'), 'crm_page_wp_crm_add_new', 'normal', 'default');      }    }    function metabox($user_object) {      global $wpi_settings;      foreach($user_object['user_invoices'] as $single_invoice) {        $single_invoice = get_invoice($single_invoice->ID);        $print[$single_invoice['post_status']][] = '<li><a href="' . admin_url("admin.php?page=wpi_page_manage_invoice&wpi[existing_invoice][invoice_id]={$single_invoice['ID']}") . '">' . $single_invoice['post_title'] . '</a></li>';      }     // echo "<pre>";print_r($print);    echo "</pre>";      $status_names = apply_filters('wpi_invoice_statuses', $wpi_settings['invoice_statuses']);      foreach($print as $invoice_status => $invoice_list) {        $status_label = ( $status_names[$invoice_status] ? $status_names[$invoice_status] : $invoice_status);        if(is_array($invoice_list)) {          echo '<b>' . $status_label . '</b><ul>' . implode('', $invoice_list) . '</ul>';        }      }    }   }